<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sugar Plant Decision Support System</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap');

        :root {
            /* TRUE DARK THEME VARS */
            --bg-gradient: linear-gradient(135deg, #000000 0%, #0a0a0a 100%);
            --card-bg: rgba(20, 20, 20, 0.6);
            --card-border: rgba(255, 255, 255, 0.15);
            --accent-green: #4ade80;
            --accent-blue: #38bdf8;
            --accent-orange: #fbbf24;
            --text-main: #f5f5f5;
            --text-muted: #a3a3a3;
            --chart-grid: rgba(255, 255, 255, 0.1);
        }

        .light-mode {
            /* LIGHT THEME VARS */
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --card-bg: rgba(255, 255, 255, 0.85);
            --card-border: rgba(0, 0, 0, 0.08);
            --accent-green: #16a34a;
            /* Darker Green for contrast */
            --accent-blue: #0284c7;
            /* Darker Blue */
            --accent-orange: #d97706;
            /* Darker Orange */
            --text-main: #1e293b;
            --text-muted: #64748b;
            --chart-grid: rgba(0, 0, 0, 0.08);
        }


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .section {
            padding: 60px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            opacity: 0;
            animation: fadeIn 0.8s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        h2 {
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 40px;
            background: linear-gradient(to right, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        p {
            line-height: 1.6;
            color: var(--text-muted);
        }

        /* HERO */
        .hero {
            height: 90vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: radial-gradient(circle at 50% 50%, rgba(74, 222, 128, 0.1) 0%, transparent 50%);
        }

        .hero h1 {
            font-size: 4rem;
            line-height: 1.1;
            margin-bottom: 20px;
            font-weight: 700;
            color: white;
        }

        .btn {
            padding: 15px 30px;
            background: var(--accent-green);
            color: #0f172a;
            border-radius: 50px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.4);
        }

        /* THEME TOGGLE */
        .theme-toggle-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-main);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* SYNC BUTTON */
        .sync-btn {
            position: fixed;
            top: 20px;
            right: 75px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-main);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .sync-btn:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.1);
        }

        .sync-bg-anim {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }



        .theme-toggle-btn:hover {
            transform: rotate(15deg) scale(1.1);
            background: var(--accent-blue);
            color: white;
            border-color: transparent;
        }

        /* PIPELINE */
        .pipeline-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin-top: 50px;
        }

        .pipeline-wrapper::before {
            content: '';
            position: absolute;
            top: 50%;
            width: 100%;
            height: 2px;
            background: var(--card-border);
            z-index: -1;
        }

        /* CARD & TOOLTIP */
        .step-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 16px;
            width: 180px;
            text-align: center;
            transition: transform 0.3s;
            cursor: pointer;
            position: relative;
            overflow: visible;
        }

        .step-card:hover {
            transform: translateY(-10px);
            border-color: var(--accent-blue);
            background: rgba(255, 255, 255, 0.1);
        }

        .step-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 1.5rem;
        }

        .step-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .step-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* ENHANCED TOOLTIP */
        .tooltip {
            visibility: hidden;
            width: 250px;
            background-color: #0f172a;
            color: #e2e8f0;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 999;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            font-size: 0.8rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--card-border);
            pointer-events: none;
        }

        .step-card:hover .tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }

        .tooltip strong {
            color: var(--accent-green);
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .tooltip ul {
            padding-left: 15px;
            margin: 0;
        }

        .tooltip li {
            margin-bottom: 2px;
        }

        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: #0f172a transparent transparent transparent;
        }

        /* GRID */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 40px;
            margin-bottom: 60px;
            align-items: center;
        }

        .visual-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 30px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .chart-placeholder {
            width: 100%;
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--card-border);
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chart-placeholder img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background-color: #0a0a0a;
            /* True Dark Modal */
            margin: 5vh auto;
            border: 1px solid var(--card-border);
            border-radius: 16px;
            width: 90%;
            max-width: 1200px;
            /* Wider for spaciousness */
            height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: zoomIn 0.3s;
            overflow: hidden;
            /* Ensure only body scrolls */
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.02);
        }

        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover {
            color: white;
        }

        .modal-body {
            display: flex;
            /* Kept for layout consistency */
            flex-direction: column;
            /* Ensure vertical stacking */
            padding: 30px;
            /* Increased Padding */
            overflow-y: auto;
            /* Enable Vertical Scrolling */
            flex-grow: 1;
            /* allow body to take available height */
        }

        .tabs {
            width: 250px;
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid var(--card-border);
            overflow-y: auto;
            padding: 20px 0;
        }

        .tab-btn {
            display: block;
            width: 100%;
            padding: 15px 20px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.95rem;
            border-left: 3px solid transparent;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .tab-btn.active {
            background: rgba(var(--accent-blue-rgb), 0.1);
            color: var(--accent-blue);
            border-left-color: var(--accent-blue);
            font-weight: 600;
        }

        /* Modal Scrollbar Customization */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-main);
        }

        .table-area {
            flex: 1;
            padding: 30px;
            overflow: auto;
            background: #0a0a0a;
            /* True Dark */
        }

        /* PREMIUM DATA TABLE STYLES (Glassmorphism) */
        .data-table {
            width: 100%;
            border-collapse: separate;
            /* Required for border-radius on rows */
            border-spacing: 0 6px;
            /* Space between rows */
            color: #cbd5e1;
            font-size: 0.9rem;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        .data-table th {
            text-align: left;
            padding: 16px 20px;
            background: rgba(10, 10, 10, 0.95);
            /* Darker, almost opaque header */
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            color: #60a5fa;
            /* Accent Blue */
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1.2px;
            z-index: 10;
            border-bottom: 2px solid rgba(96, 165, 250, 0.3);
            text-shadow: 0 0 10px rgba(96, 165, 250, 0.2);
        }

        .data-table td {
            text-align: left;
            padding: 14px 20px;
            background: rgba(23, 23, 23, 0.4);
            /* Translucent Row Background */
            border: none;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .data-table tr td:first-child {
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
            border-left: 1px solid rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
            /* Brighter text for first column (Parameter Name) */
            font-weight: 500;
        }

        .data-table tr td:last-child {
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .data-table tr {
            transition: all 0.2s ease;
        }

        .data-table tr:hover td {
            background: rgba(59, 130, 246, 0.1);
            /* Blue tint on hover */
            transform: scale(1.005);
            /* Micro-interaction scale */
            border-color: rgba(96, 165, 250, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* P2P DIGITAL TWIN STYLES */
        .p2p-twin-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            min-height: 500px;
            /* Flexible height to prevent overlap */
            color: #fff;
        }

        /* SVG MAP */
        .svg-map-container {
            background: rgba(10, 10, 10, 0.6);
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.5);
        }

        .energy-path {
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
            opacity: 0.3;
            transition: all 0.5s ease;
        }

        .energy-path.active {
            stroke: #4ade80;
            opacity: 1;
            filter: drop-shadow(0 0 4px #4ade80);
            stroke-dasharray: 10, 10;
            animation: flowStream 1s linear infinite;
        }

        .energy-path.partial {
            stroke: #fbbf24;
            opacity: 0.8;
            stroke-dasharray: 15, 15;
            animation: flowStream 2s linear infinite;
        }

        @keyframes flowStream {
            from {
                stroke-dashoffset: 20;
            }

            to {
                stroke-dashoffset: 0;
            }
        }

        .node-icon {
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.5));
            transition: all 0.3s ease;
            transform-origin: center;
        }

        .center-node {
            animation: pulseNeon 3s infinite;
        }

        @keyframes pulseNeon {
            0% {
                filter: drop-shadow(0 0 5px #3b82f6);
                transform: scale(1);
            }

            50% {
                filter: drop-shadow(0 0 20px #3b82f6);
                transform: scale(1.05);
            }

            100% {
                filter: drop-shadow(0 0 5px #3b82f6);
                transform: scale(1);
            }
        }

        /* PRIORITY STACK with Water Tank Effect */
        .priority-stack {
            background: rgba(23, 23, 23, 0.8);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stack-level {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid transparent;
            min-height: 50px;
            transition: all 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .stack-level.filled {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.1);
        }

        /* GAUGE */
        .gauge-container {
            position: relative;
            width: 100%;
            height: 100px;
            overflow: hidden;
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }

        .gauge-bg {
            width: 160px;
            height: 80px;
            background: #334155;
            border-radius: 90px 90px 0 0;
            position: relative;
        }

        .gauge-needle {
            width: 4px;
            height: 70px;
            background: #fff;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform-origin: bottom center;
            transform: rotate(-90deg);
            /* Start full left */
            transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
        }

        /* HUMAN SNAPSHOT ICONS */
        .human-impact-row {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .impact-tile {
            text-align: center;
            opacity: 0.3;
            transition: all 0.5s;
        }

        .impact-tile.active {
            opacity: 1;
            text-shadow: 0 0 10px currentColor;
        }

        .node {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 2px solid var(--accent-blue);
            position: relative;
        }

        .node-main {
            border-color: var(--accent-green);
            background: rgba(74, 222, 128, 0.1);
        }

        .big-stat {
            font-size: 3rem;
            font-weight: 700;
            color: var(--accent-green);
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 0.9rem;
            letter-spacing: 1px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* FORECASTING STYLES */
        .metric-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--card-border);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 10px 0;
            color: white;
        }

        .metric-delta {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .alert-item {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid;
            background: rgba(255, 255, 255, 0.02);
            font-size: 0.9rem;
        }

        .alert-item.success {
            border-color: #4ade80;
        }

        .alert-item.warning {
            border-color: #fbbf24;
        }

        .alert-item.info {
            border-color: #60a5fa;
        }

        .alert-item strong {
            display: block;
            margin-bottom: 5px;
            color: #f8fafc;
        }

        .alert-item p {
            margin: 0;
            color: #94a3b8;
        }
    </style>
</head>

<body>
    <!-- Theme Toggle Removed -->

    <!-- Sync Button Removed -->
    <div class="hero">
        <h1 style="color:white">Energy <span style="color:var(--accent-green)">Intelligent</span>.</h1>
        <p>Operational Decision Support for Sugarcane Cogen Plants</p>
        <div style="display: flex; gap: 30px; margin: 30px 0;">
            <div>
                <div class="big-stat" id="hero-mwh-export" style="font-size: 2rem;">--</div>
                <div class="stat-label">MWh Export</div>
            </div>
            <div>
                <div class="big-stat" id="hero-recovery-pct" style="font-size: 2rem; color:#60a5fa;">--%</div>
                <div class="stat-label">Recovery</div>
            </div>
        </div>
        <div style="display: flex; gap: 15px;">
            <a href="#pipeline" class="btn">Explore System <svg viewBox="0 0 24 24">
                    <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z" />
                </svg></a>
            <!-- NEW: Data Insights Button -->
            <button onclick="document.getElementById('insightsModal').style.display='block'" class="btn"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #94a3b8;">
                Data Insights üìä
            </button>
            <!-- NEW: Model Performance Button -->
            <button onclick="document.getElementById('performanceModal').style.display='block'" class="btn"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #a5b4fc;">
                Model Perf üìà
            </button>
        </div>
    </div>

    <div class="container">
        <!-- PIPELINE -->
        <section id="pipeline" class="section">
            <h2>The System Workflow</h2>
            <div class="pipeline-wrapper">
                <!-- DPR BUTTON WITH INSIGHTS -->
                <div class="step-card" onclick="openDPRModal()">
                    <div class="tooltip">
                        <strong>Input Insights (8 Datasets)</strong>
                        <ul>
                            <li>Plant Overview & Config</li>
                            <li>Boiler & Turbine Operation</li>
                            <li>Cane & Bagasse Flows</li>
                            <li>Power Balance & Import/Export</li>
                        </ul>
                    </div>
                    <div class="step-icon" style="color: #fbbf24; border: 2px solid #fbbf24;">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" />
                        </svg>
                    </div>
                    <div class="step-title">DPR Data</div>
                    <div class="step-desc" style="color: #fbbf24;">Inspect Live Input</div>
                </div>

                <!-- Other cards -->
                <div class="step-card" onclick="openForecastingModal()">
                    <div class="tooltip">
                        <strong>Forecasting</strong>
                        <p style="margin:0; font-size:0.8rem;">Real-time prediction of power generation using historical
                            DPR data.</p>
                    </div>
                    <div class="step-icon" style="color: #60a5fa;"><svg viewBox="0 0 24 24">
                            <path
                                d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" />
                        </svg></div>
                    <div class="step-title">Forecasting</div>
                    <div class="step-desc">AI Prediction</div>
                </div>
                <div class="step-card" onclick="openOptimizationModal()">
                    <div class="step-icon" style="color: #4ade80;"><svg viewBox="0 0 24 24">
                            <path d="M7 2v11h3v9l7-12h-4l4-8z" />
                        </svg></div>
                    <div class="step-title">Optimization</div>
                    <div class="step-desc">Loss Recovery</div>
                </div>
                <div class="step-card" onclick="openP2PModal()">
                    <div class="step-icon" style="color: #a78bfa;"><svg viewBox="0 0 24 24">
                            <path
                                d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                        </svg></div>
                    <div class="step-title">P2P Trading</div>
                    <div class="step-desc">Local Market</div>
                </div>
            </div>
        </section>

        <!-- VISUALS -->
        <section class="section">
            <div class="results-grid">
                <div class="visual-card" onclick="openForecastingModal()" style="cursor: pointer;">
                    <div class="stat-label">Planning</div>
                    <h3 style="color: #60a5fa;">Forecasted Availability</h3>
                    <p>Predicted Generation vs Load.</p>
                </div>
                <div class="chart-container" onclick="openForecastingModal()"
                    style="cursor: pointer; background: rgba(255,255,255,0.02); border: 1px solid var(--card-border); border-radius: 12px; padding: 10px;">
                    <canvas id="availabilityCardChart"></canvas>
                </div>
            </div>
            <div class="results-grid">
                <div class="chart-container"
                    style="background: rgba(255,255,255,0.02); border: 1px solid var(--card-border); border-radius: 12px; padding: 10px; height: 200px; position: relative;">
                    <canvas id="efficiencyCardChart"></canvas>
                </div>
                <div class="visual-card">
                    <div class="stat-label">Efficiency</div>
                    <h3 style="color: #4ade80;">Waste Reduction</h3>
                    <p>Finding hidden capacity through optimization.</p>
                </div>
            </div>
            <div class="results-grid">
                <div class="visual-card">
                    <div class="stat-label">Market</div>
                    <h3 style="color: #fbbf24;">P2P Revenue</h3>
                    <p>Selling 100% surplus locally.</p>
                </div>
                <div class="chart-container"
                    style="background: rgba(255,255,255,0.02); border: 1px solid var(--card-border); border-radius: 12px; padding: 10px; height: 200px; position: relative;">
                    <canvas id="p2pCardChart"></canvas>
                </div>
            </div>
        </section>

        <!-- SUSTAINABILITY -->
        <section class="section">
            <h2>Sustainability Impact</h2>
            <div class="results-grid">
                <div class="chart-container"
                    style="background: rgba(255,255,255,0.02); border: 1px solid var(--card-border); border-radius: 12px; padding: 10px; height: 200px; position: relative;">
                    <canvas id="carbonCardChart"></canvas>
                </div>
                <div class="visual-card">
                    <div class="stat-label">CO¬≤ Savings</div>
                    <h3 style="color: #4ade80;">Carbon Footprint</h3>
                    <p>Reduction achieved through efficiency and local trading.</p>
                </div>
            </div>
            <div class="results-grid">
                <div class="visual-card">
                    <div class="stat-label">Equivalency</div>
                    <h3 style="color: #fbbf24;">Real World Impact</h3>
                    <p>What this means for the planet.</p>
                </div>
                <div class="chart-container" id="equivalencyContainer"
                    style="background: rgba(255,255,255,0.02); border: 1px solid var(--card-border); border-radius: 12px; padding: 20px; height: 200px; display: flex; align-items: center; justify-content: space-around; flex-direction: row;">
                    <!-- Content injected by JS -->
                </div>
            </div>
        </section>
    </div>

    <!-- DPR DATA MODAL -->
    <div id="dprModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h3 style="margin:0;">Input Data Explorer</h3>
                    <div id="syncTime" style="font-size: 0.8rem; color: #4ade80; margin-top: 5px;">Connecting to
                        Server...</div>
                </div>
                <span class="close-btn" onclick="closeDPRModal()">&times;</span>
            </div>
            <div class="modal-body" style="flex-direction: row !important;">
                <div class="tabs" id="modalTabs"></div>
                <div class="table-area" id="modalTableContainer"
                    style="display:flex; justify-content:center; align-items:center;">
                    <div class="loader" style="color:#aaa;">Click a tab to load live data...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- DAY DETAIL MODAL -->
    <div id="dayDetailModal" class="modal" style="z-index: 2000;">
        <div class="modal-content" style="height: auto; max-width: 500px; padding: 0; overflow: hidden;">
            <div class="modal-header">
                <h3>Daily Breakdown</h3>
                <span class="close-btn"
                    onclick="document.getElementById('dayDetailModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <h2 id="dd-title" style="margin-bottom: 20px; color: var(--accent-green);">Day X</h2>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="visual-card" style="padding: 15px;">
                        <div class="stat-label">Generation</div>
                        <h4 id="dd-gen" style="color:white; font-size: 1.2rem;">0 MWh</h4>
                    </div>
                    <div class="visual-card" style="padding: 15px;">
                        <div class="stat-label">Demand</div>
                        <h4 id="dd-demand" style="color:white; font-size: 1.2rem;">0 MWh</h4>
                    </div>
                </div>

                <div class="visual-card"
                    style="padding: 20px; border: 1px solid var(--card-border); background: rgba(0,0,0,0.2); margin-bottom: 20px;">
                    <div style="display:flex; justify-content:space-between;">
                        <span class="stat-label">Net Surplus</span>
                        <span id="dd-surplus" style="font-weight:bold; color:white;">0 MWh</span>
                    </div>
                    <div class="progress-bar-bg" style="margin-top: 10px;">
                        <div id="dd-bar" class="progress-bar-fill" style="width: 50%;"></div>
                    </div>
                    <p id="dd-risk" style="margin-top: 10px; font-size: 0.8rem; color: var(--text-muted);"></p>
                </div>

                <div
                    style="background: rgba(251, 191, 36, 0.1); border-left: 3px solid var(--accent-orange); padding: 15px; border-radius: 4px;">
                    <strong style="color: var(--accent-orange); font-size: 0.9rem;">Analysis</strong>
                    <p id="dd-desc" style="font-size: 0.85rem; color: #cbd5e1; margin-top: 5px;">
                        Stable operation expected.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openDayDetails(row) {
            const modal = document.getElementById('dayDetailModal');

            // Bind Data
            document.getElementById('dd-title').innerText = row.Day;
            document.getElementById('dd-gen').innerText = row.Power_Generated_MWh + " MWh";
            document.getElementById('dd-demand').innerText = row.Internal_Demand_MWh + " MWh";

            const surplus = parseFloat(row.Power_Surplus_MWh);
            const surplusEl = document.getElementById('dd-surplus');
            surplusEl.innerText = (surplus > 0 ? "+" : "") + surplus + " MWh";
            surplusEl.style.color = surplus >= 0 ? "#4ade80" : "#ef4444";

            // Bar Width (Max assumed 200 for viz)
            const pct = Math.min(Math.max((surplus / 200) * 100, 0), 100);
            document.getElementById('dd-bar').style.width = pct + "%";
            document.getElementById('dd-bar').style.backgroundColor = surplus >= 0 ? "#4ade80" : "#ef4444";

            // Risk Text
            const risk = row.Risk_Level || "LOW";
            document.getElementById('dd-risk').innerHTML = `Risk Level: <span style="color:${risk === 'HIGH' ? '#ef4444' : (risk === 'MEDIUM' ? '#f97316' : '#4ade80')}">${risk}</span>`;

            // Description
            document.getElementById('dd-desc').innerText = row.Operational_Reason || "Normal operation within expected parameters.";

            modal.style.display = "block";
        }

        const DATA_KEYS = [
            'Plant Overview', 'Boiler & Turbine', 'Cane & Bagasse', 'Steam Parameters',
            'Power Balance', 'Annual Summary', 'Ethanol Plant', '7-Day Forecast'
        ];

        const COLUMN_DEFINITIONS = {
            "Steam_Generation": { desc: "Total high-pressure steam produced by the boiler.", formula: "Feed Water - Blowdown" },
            "Power_Generation": { desc: "Active power output from the Turbo-Generator.", formula: "V x I x pf (approx)" },
            "Bagasse_Consumption": { desc: "Rate of fuel (bagasse) firing in the boiler.", formula: "Steam Flow / Steam-Fuel Ratio" },
            "Specific_Steam_Consumption": { desc: "Steam required to generate 1 MW of power.", formula: "Total Steam (TPH) / Total Power (MW)" },
            "Auxiliary_Consumption": { desc: "Power consumed by internal pumps & fans.", formula: "~10% of Generation" },
            "Exportable_Surplus": { desc: "Net power available for export.", formula: "Gen - Aux - Internal" },
            "Boiler_Efficiency": { desc: "Percentage of fuel energy converted into steam.", formula: "(Steam Energy / Fuel Energy) * 100" }
        };

        // Global Data State
        let plantData = null;

        // --- STRICT DATA-DRIVEN ARCHITECTURE ---
        // Configuration Mapping: Links logical names to potential Google Sheet row names
        const CONFIG_KEYS = {
            TOTAL_LOSS_RATIO: ["System Total Loss %", "Total Loss Ratio", "Baseline Loss %"],
            RECOVERABLE_CAP: ["Recoverable Loss %", "Recoverable Cap", "Max Recovery %"],
            UNAVOIDABLE_FLOOR: ["Unavoidable Loss %", "Loss Floor"],
            GRID_EMISSION_FACTOR: ["Grid Emission Factor", "CO¬≤ Factor", "Emission Factor (tCO¬≤/MWh)"],
            HOUSEHOLD_CONSUMPTION: ["Household Consumption", "Avg Home Consumption", "Daily Household kWh"],
            REVENUE_RATE: ["Revenue Rate", "Market Price", "P2P Rate (INR/MWh)"],
            RISK_LOW: ["Risk Threshold Low", "Safety Margin"],
            RISK_MEDIUM: ["Risk Threshold Medium", "Warning Margin"],
        };

        // Helper: Fetch parameter with fuzzy matching and validation logging
        function getParam(keyAliases, fallbackValue) {
            if (!plantData || !plantData['Steam Parameters'] || !plantData['Steam Parameters'].rows) {
                console.warn(`[DATA LOADING] Steam Parameters sheet not ready. Using fallback: ${fallbackValue}`);
                return fallbackValue;
            }

            const rows = plantData['Steam Parameters'].rows;
            // Strategy: Look for a row where 'Parameter' or 'Name' matches one of the aliases
            // Then return the 'Value' column.

            for (let alias of keyAliases) {
                const match = rows.find(r =>
                    (r.Parameter && r.Parameter.toLowerCase() === alias.toLowerCase()) ||
                    (r.Name && r.Name.toLowerCase() === alias.toLowerCase())
                );

                if (match) {
                    // Try to parse 'Value'
                    const val = parseFloat(match.Value);
                    if (!isNaN(val)) {
                        console.log(`[DATA BINDING] Found ${alias}: ${val}`);
                        return val;
                    }
                }
            }

            console.error(`[DATA BINDING ERROR] Could not find parameter matching: ${keyAliases.join(', ')}. Using fallback:
    ${fallbackValue}`);
            return fallbackValue;
        }

        // --- 2. BACKEND API LOGIC ---
        async function fetchPlantData(forceRefresh = false) {
            const syncLabel = document.getElementById('syncTime');
            if (syncLabel) syncLabel.innerText = forceRefresh ? "Syncing with Google Sheets (Server)..." : "Checking Server Cache...";

            try {
                const url = forceRefresh ? 'http://localhost:8000/api/data?refresh=true' : 'http://localhost:8000/api/data';
                const res = await fetch(url);
                if (!res.ok) throw new Error("Server Error");

                const json = await res.json(); // Array or Object?

                // Inspect structure
                plantData = json.data || json;

                if (plantData && plantData.meta) {
                    const status = forceRefresh ? "Live Synced" : "Cached";
                    if (syncLabel) syncLabel.innerHTML = `<span style="color:#4ade80">‚óè ${status}</span>
    (${plantData.meta.lastUpdated})`;
                }

                // Refresh current tab if open
                const activeBtn = document.querySelector('.tab-btn.active');
                if (activeBtn) loadTab(activeBtn.innerText, activeBtn);

                // >>> DYNAMIC UPDATE: Refresh all dashboard elements <<<
                updateDashboardFromData();

            } catch (err) {
                console.error(err);
                if (syncLabel) syncLabel.innerText = "Connection Failed. Is python3 server.py running?";
            }
        }

        // --- 3. UI LOGIC ---
        const modal = document.getElementById('dprModal');
        const tabsContainer = document.getElementById('modalTabs');
        const tableContainer = document.getElementById('modalTableContainer');

        function openDPRModal() {
            modal.style.display = "block";

            // Initial Fetch if empty
            if (!plantData) {
                fetchPlantData(false); // Load from cache first
            }

            // Render Tabs
            if (tabsContainer.innerHTML === "") {
                DATA_KEYS.forEach((key, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'tab-btn';
                    btn.innerText = key;
                    btn.onclick = () => loadTab(key, btn);
                    tabsContainer.appendChild(btn);
                    if (index === 0) loadTab(key, btn); // Pre-select but wait for data
                });
            }
        }

        function loadTab(key, btnElem) {
            // UI Active State
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if (btnElem) btnElem.classList.add('active');

            if (!plantData) {
                tableContainer.innerHTML = '<div class="loader">Loading data from backend...</div>';
                return;
            }

            const data = plantData[key];

            if (!data) {
                tableContainer.innerHTML = `<div style="padding:40px; color:#f87171;">No data found for '${key}'.</div>`;
                return;
            }

            // ROBUST SORT for Daily Flows
            if (key === 'Daily Flows' && data.rows) {
                console.log("Sorting Daily Flows...");
                data.rows.sort((a, b) => {
                    const valA = a['Day'] ?? a['DAY'] ?? a['day'] ?? 0;
                    const valB = b['Day'] ?? b['DAY'] ?? b['day'] ?? 0;
                    return (parseInt(valA) || 0) - (parseInt(valB) || 0);
                });
            }

            renderTable(data);

            // AGGRESSIVE SCROLL RESET (Fixes "Starts at 101" bug)
            // 1. Immediate
            if (tableContainer) tableContainer.scrollTop = 0;
            if (modal) modal.scrollTop = 0;

            // 2. Delayed (Post-Render)
            setTimeout(() => {
                if (tableContainer) tableContainer.scrollTop = 0;
                if (modal) modal.scrollTop = 0;
                console.log("Scroll forced to top.");
            }, 10);
        }


        function renderTable(data) {
            let html = `<table class="data-table">
                <thead>
                <tr>`;
            data.columns.forEach(col => {
                let def = COLUMN_DEFINITIONS[col] || COLUMN_DEFINITIONS[Object.keys(COLUMN_DEFINITIONS).find(k => col.includes(k))];
                html += `<th>
                        ${col}
                        ${def ? `<div class="tooltip" style="width:200px; bottom: 100%; left:50%; margin-left:-100px; font-weight:normal; text-transform:none;">
                            <strong>Insight:</strong> ${def.desc}<br><br><em style="color:#fbbf24">Formula: ${def.formula}</em>
                        </div>` : ''}
                    </th>`;
            });
            html += `</tr></thead><tbody>`;

            const rowLimit = Math.min(data.rows.length, 1000);
            for (let i = 0; i < rowLimit; i++) {
                let row = data.rows[i];
                html += `<tr>`;
                data.columns.forEach(col => {
                    let val = row[col];
                    if (val === null || val === undefined) val = "-";

                    // DYNAMIC STYLING FOR RISK LEVEL
                    if (col === "Risk_Level") {
                        let color = "#4ade80"; // Green
                        let text = String(val).toUpperCase();
                        if (text === "HIGH") color = "#ef4444"; // Red
                        else if (text === "MEDIUM") color = "#f97316"; // Orange

                        html += `<td><span style="color:${color}; font-weight:bold; background:rgba(0,0,0,0.3); padding:4px 8px; border-radius:4px; border:1px solid ${color}40">${val}</span></td>`;
                    } else if (col === "Power_Surplus_MWh") {
                        let color = parseFloat(val) < 0 ? "#f87171" : "#e2e8f0";
                        html += `<td style="color:${color}; font-weight:600;">${val}</td>`;
                    } else {
                        html += `<td>${val}</td>`;
                    }
                });
                html += `</tr>`;
            }
            html += `</tbody></table>`;

            tableContainer.innerHTML = html;
        }

        function closeDPRModal() { modal.style.display = "none"; }
        window.onclick = function (e) { if (e.target == modal) closeDPRModal(); }

        // Add a manual sync button to header
        setTimeout(() => {
            const header = document.querySelector('.modal-header div');
            if (header && !document.getElementById('forceSyncBtn')) {
                const syncBtn = document.createElement('button');
                syncBtn.id = 'forceSyncBtn';
                syncBtn.innerText = "‚Üª Force Sync";
                syncBtn.style = "background:none; border:1px solid #4ade80; color:#4ade80; padding:5px 10px; border-radius:5px; cursor: pointer; font-size: 0.8rem; margin-top: 5px;";
                syncBtn.onclick = () => fetchPlantData(true);
                header.appendChild(syncBtn);
            }
        }, 1000);


    </script>

    <!-- FORECASTING MODAL -->

    <div id="forecastingModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; height: auto; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Plant Generation Forecast</h3>
                <span class="close-btn" onclick="closeForecastingModal()">&times;</span>
            </div>
            <div class="modal-body" style="display: block; padding: 30px;">

                <!-- BLOCK 1: TOMORROW'S SNAPSHOT -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
                    <div class="metric-card">
                        <div class="metric-label">Expected Gen</div>
                        <div class="metric-value" id="fc-gen">-- MWh</div>
                        <div class="metric-delta">Tomorrow</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Internal Demand</div>
                        <div class="metric-value" id="fc-demand">-- MWh</div>
                        <div class="metric-delta">Tomorrow</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Expected Surplus</div>
                        <div class="metric-value" id="fc-surplus" style="color: #4ade80;">-- MWh</div>
                        <div class="metric-delta">Tomorrow</div>
                    </div>
                    <div class="metric-card" id="fc-risk-card">
                        <div class="metric-label">Risk Level</div>
                        <div class="metric-value" id="fc-risk">LOW</div>
                        <div class="metric-delta">Grid Stability</div>
                    </div>
                </div>

                <!-- BLOCK 2: 7-DAY OUTLOOK -->
                <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 30px;">
                    <div class="chart-container"
                        style="background: rgba(255,255,255,0.02); padding: 20px; border-radius: 12px; border: 1px solid var(--card-border);">
                        <h4 style="margin-bottom: 20px;">7-Day Power Outlook</h4>
                        <canvas id="forecastChart"></canvas>
                    </div>

                    <!-- BLOCK 3: FORECAST TABLE (Matched to Sheet) -->
                    <div style="grid-column: span 2; margin-top: 30px;">
                        <h4 style="margin-bottom: 15px;">Detailed Forecast Data</h4>
                        <div
                            style="overflow-x: auto; background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px solid var(--card-border);">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;"
                                id="forecast-table">
                                <thead>
                                    <tr
                                        style="background: rgba(255,255,255,0.05); color: #94a3b8; text-transform: uppercase; font-size: 0.8rem; text-align: left;">
                                        <th style="padding: 15px;">Day</th>
                                        <th style="padding: 15px;">Generation (MWh)</th>
                                        <th style="padding: 15px;">Demand (MWh)</th>
                                        <th style="padding: 15px;">Surplus (MWh)</th>
                                        <th style="padding: 15px;">Risk Level</th>
                                        <th style="padding: 15px;">Operational Reason</th>
                                    </tr>
                                </thead>
                                <tbody style="color: #e2e8f0;">
                                    <!-- Populated via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- BLOCK 3: ALERTS -->
                    <div class="alerts-container">
                        <h4 style="margin-bottom: 15px;">Smart Alerts</h4>
                        <div class="alert-item success">
                            <strong>Safe Week</strong>
                            <p>No power deficit expected in next 7 days.</p>
                        </div>
                        <div class="alert-item warning" id="alert-surplus-dip" style="display:none;">
                            <strong>Low Surplus</strong>
                            <p>Surplus dips below 10% on Day <span id="alert-dip-day">--</span>.</p>
                        </div>
                        <div class="alert-item info">
                            <strong>Optimization</strong>
                            <p>Boiler efficiency is holding steady at >65%.</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- OPTIMIZATION MODAL -->
    <div id="optimizationModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; height: 90vh; overflow-y: auto; display: block;">
            <div class="modal-header">
                <h3>System Optimization & Loss Recovery</h3>
                <span class="close-btn" onclick="closeOptimizationModal()">&times;</span>
            </div>
            <div class="modal-body" style="display: block; padding: 30px;">

                <!-- SECTION 1: LOSS BREAKDOWN -->
                <div style="margin-bottom: 40px;">
                    <h4 style="margin-bottom: 15px; border-left: 4px solid #f87171; padding-left: 10px;">
                        1. Baseline System Losses (Operational + Physical)
                    </h4>

                    <div
                        style="background: rgba(255,255,255,0.02); padding: 20px; border-radius: 12px; border: 1px solid var(--card-border);">
                        <div
                            style="display:flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem;">
                            <span>Total System Losses: <strong id="opt-total-loss">-- MWh</strong></span>
                            <span style="color:#4ade80">Recoverable Potential: <strong id="opt-recoverable">--
                                    MWh</strong></span>
                        </div>

                        <!-- STACKED BAR -->
                        <div id="loss-stack-container"
                            style="height: 30px; width: 100%; background: #334155; border-radius: 15px; overflow: hidden; display: flex; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);">
                            <div
                                style="width: 70%; background: #64748b; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: #cbd5e1; border-right: 1px solid rgba(255,255,255,0.1);">
                                70% Unavoidable (Thermodynamic Limits)</div>
                            <div
                                style="width: 30%; background: #4ade80; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: #064e3b; font-weight: bold;">
                                30% Recoverable</div>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.75rem; color: #64748b; text-align: right;">
                            *Optimization operates only within physically feasible recovery limits.<br>
                            *Higher recovery would require capital upgrades, not operational optimization.
                        </div>

                        <!-- Detailed Breakdown Grid -->
                        <div id="loss-breakdown-container"
                            style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                        </div>
                    </div>
                </div>

                <!-- SECTION 2: BEFORE vs AFTER -->
                <div style="margin-bottom: 40px;">
                    <h4 style="margin-bottom: 15px; border-left: 4px solid #60a5fa; padding-left: 10px;">
                        2. Impact Analysis: Before vs After Optimization
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <!-- BEFORE -->
                        <div
                            style="background: rgba(255,255,255,0.02); padding: 20px; border-radius: 12px; border: 1px solid var(--card-border);">
                            <h5
                                style="color: #94a3b8; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px;">
                                Baseline Operation</h5>
                            <div
                                style="margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px;">
                                <span style="color:#94a3b8">Exportable Energy</span>
                                <span style="float:right; font-weight:bold; font-size: 1.1rem;" id="opt-base-export">--
                                    MWh</span>
                            </div>
                            <div>
                                <span style="color:#94a3b8">Baseline System Losses</span>
                                <span style="float:right; font-weight:bold; font-size: 1.1rem; color: #f87171;"
                                    id="opt-base-loss">-- MWh</span>
                            </div>
                        </div>

                        <!-- AFTER -->
                        <div
                            style="background: rgba(74, 222, 128, 0.05); padding: 20px; border-radius: 12px; border: 1px solid #4ade80;">
                            <h5
                                style="color: #4ade80; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px;">
                                Optimized Operation</h5>
                            <div
                                style="margin-bottom: 15px; border-bottom: 1px solid rgba(74, 222, 128, 0.2); padding-bottom: 10px;">
                                <span style="color:#94a3b8">Exportable Energy</span>
                                <span style="float:right; font-weight:bold; font-size: 1.1rem; color:#4ade80;"
                                    id="opt-new-export">-- MWh</span>
                                <span
                                    style="float:right; font-size: 0.8rem; color:#4ade80; margin-right: 10px; background: rgba(74, 222, 128, 0.1); padding: 2px 6px; border-radius: 4px;">‚ñ≤
                                    <span id="opt-gain">--</span></span>
                            </div>
                            <div
                                style="margin-bottom: 15px; border-bottom: 1px solid rgba(74, 222, 128, 0.2); padding-bottom: 10px;">
                                <span style="color:#94a3b8">System Losses</span>
                                <span style="float:right; font-weight:bold; font-size: 1.1rem; color: #fbbf24;"
                                    id="opt-new-loss">-- MWh</span>
                                <span
                                    style="float:right; font-size: 0.8rem; color:#fbbf24; margin-right: 10px; background: rgba(251, 191, 36, 0.1); padding: 2px 6px; border-radius: 4px;">‚ñº
                                    Reduced</span>
                            </div>
                            <div>
                                <div>
                                    <span style="color:#94a3b8">Emissions Offset</span>
                                    <span style="float:right; font-weight:bold; font-size: 1.1rem; color:#fff;"
                                        id="opt-co2">-- tCO¬≤</span>
                                </div>
                                <div style="font-size: 0.7rem; color: #64748b; margin-top: 2px;">Estimated using average
                                    grid emission factor.</div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; font-size: 0.9rem; color: #94a3b8;">
                        Optimization reallocates recoverable losses into useful export energy through improved
                        operational efficiency.
                    </div>
                </div>

                <!-- SECTION 3: P2P READINESS -->
                <div>
                    <h4 style="margin-bottom: 15px; border-left: 4px solid #a78bfa; padding-left: 10px;">
                        3. P2P Trading Readiness
                    </h4>
                    <div
                        style="display: flex; align-items: center; justify-content: space-around; background: rgba(255,255,255,0.02); padding: 30px; border-radius: 12px; border: 1px solid var(--card-border);">
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; color: #4ade80; font-weight: bold; line-height: 1;"
                                id="p2p-mwh">--</div>
                            <div
                                style="font-size: 0.8rem; text-transform: uppercase; color: #94a3b8; margin-top: 10px;">
                                Extra MWh Available</div>
                        </div>
                        <div style="font-size: 2rem; color: #64748b; opacity: 0.5;">‚Üí</div>
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; color: #60a5fa; font-weight: bold; line-height: 1;"
                                id="p2p-homes">--</div>
                            <div
                                style="font-size: 0.8rem; text-transform: uppercase; color: #94a3b8; margin-top: 10px;">
                                Households Powered</div>
                            <div style="font-size: 0.65rem; color: #64748b; margin-top: 4px;">Assuming ~15 kWh/day per
                                household (approximate).</div>
                        </div>
                        <div style="font-size: 2rem; color: #64748b; opacity: 0.5;">‚Üí</div>
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; color: #fbbf24; font-weight: bold; line-height: 1;"
                                id="p2p-rev">--</div>
                            <div
                                style="font-size: 0.8rem; text-transform: uppercase; color: #94a3b8; margin-top: 10px;">
                                Est. Revenue Increase</div>
                            <div style="font-size: 0.65rem; color: #64748b; margin-top: 4px;">Indicative estimate based
                                on prevailing short-term market rates.</div>
                        </div>
                    </div>
                    <div
                        style="margin-top: 15px; font-size: 0.8rem; color: #64748b; font-style: italic; text-align: center;">
                        Recovered energy is first allocated to internal stability; only surplus is made available
                        for
                        P2P trading.
                    </div>
                    <div
                        style="margin-top: 30px; padding: 20px; background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; border-radius: 4px; color: #e2e8f0; font-size: 0.95rem; line-height: 1.6;">
                        <strong>Conclusion:</strong> The optimization module identifies realistic energy recovery
                        opportunities within physical limits, converting recoverable system losses into additional
                        export potential and improved readiness for peer-to-peer energy trading.
                    </div>
                </div>

            </div>
        </div>
    </div>
    <!-- P2P MODAL (DIGITAL TWIN) -->
    <div id="p2pModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; background: #0f172a; border: 1px solid #3b82f6;">
            <div class="modal-header" style="border-bottom: 1px solid rgba(59, 130, 246, 0.3);">
                <h3 style="color: #60a5fa; text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);">P2P Energy Trading</h3>
                <span class="close-btn" onclick="closeP2PModal()">&times;</span>
            </div>
            <div class="modal-body" style="padding: 30px;">

                <div class="p2p-twin-container">
                    <!-- LEFT: DIGITAL TWIN MAP (Center-Outward) -->
                    <div class="svg-map-container" style="flex-direction: column;">

                        <!-- Flow Story Caption -->
                        <div
                            style="width: 100%; text-align: center; margin-top: 50px; color: #94a3b8; font-size: 0.9rem; font-weight: bold; letter-spacing: 1px;">
                            SURPLUS ENERGY <span style="color:#4ade80">‚Üí</span> PRIORITY ALLOCATION <span
                                style="color:#4ade80">‚Üí</span> P2P TRADING
                        </div>

                        <svg viewBox="0 0 800 600" style="width: 100%; height: 100%;">
                            <!-- Background Grid -->
                            <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                                <path d="M 40 0 L 0 0 0 40" fill="none" stroke="rgba(59, 130, 246, 0.05)"
                                    stroke-width="1" />
                            </pattern>
                            <rect width="100%" height="100%" fill="url(#grid)" />

                            <!-- CONNECTIONS (Outward Flow) -->
                            <!-- Center to Village (Top Right) -->
                            <path id="stream-village" class="energy-path" d="M 400 300 L 600 150"
                                stroke-dasharray="10 10" />
                            <!-- Center to Storage (Bottom Right) -->
                            <path id="stream-storage" class="energy-path" d="M 400 300 L 600 450"
                                stroke-dasharray="10 10" />
                            <!-- Center to EV (Bottom Left) -->
                            <path id="stream-ev" class="energy-path" d="M 400 300 L 200 450" stroke-dasharray="10 10" />
                            <!-- Center to Market (Top Left) -->
                            <path id="stream-market" class="energy-path" d="M 400 300 L 200 150"
                                stroke-dasharray="10 10" />

                            <!-- NODES -->
                            <!-- Central Plant -->
                            <g transform="translate(400, 300)">
                                <g class="center-node">
                                    <!-- Glowing Core -->
                                    <circle r="50" fill="url(#plantGradient)" stroke="#4ade80" stroke-width="2" />
                                    <text y="5" fill="#fff" text-anchor="middle" font-size="24">‚ö°</text>
                                    <text y="80" fill="#4ade80" text-anchor="middle" font-size="14"
                                        font-weight="bold">SURPLUS SOURCE</text>
                                </g>
                            </g>
                            <defs>
                                <radialGradient id="plantGradient">
                                    <stop offset="0%" stop-color="#4ade80" stop-opacity="0.4" />
                                    <stop offset="100%" stop-color="#4ade80" stop-opacity="0" />
                                </radialGradient>
                            </defs>

                            <!-- Village (Top Right) -->
                            <g class="node-icon" id="node-village" transform="translate(600, 150)">
                                <circle r="30" fill="#1e293b" stroke="#94a3b8" stroke-width="2" />
                                <text y="10" fill="#fff" text-anchor="middle" font-size="22">üè†</text>
                                <text y="50" fill="#94a3b8" text-anchor="middle" font-size="12">Village
                                    (Essential)</text>
                            </g>

                            <!-- Storage (Bottom Right) -->
                            <g class="node-icon" id="node-storage" transform="translate(600, 450)">
                                <circle r="30" fill="#1e293b" stroke="#94a3b8" stroke-width="2" />
                                <text y="10" fill="#fff" text-anchor="middle" font-size="22">üßä</text>
                                <text y="50" fill="#94a3b8" text-anchor="middle" font-size="12">Cold Storage</text>
                            </g>

                            <!-- EV Hub (Bottom Left) -->
                            <g class="node-icon" id="node-ev" transform="translate(200, 450)">
                                <circle r="30" fill="#1e293b" stroke="#94a3b8" stroke-width="2" />
                                <text y="10" fill="#fff" text-anchor="middle" font-size="22">üîå</text>
                                <text y="50" fill="#94a3b8" text-anchor="middle" font-size="12">EV Hub</text>
                            </g>

                            <!-- Market (Top Left) -->
                            <g class="node-icon" id="node-market" transform="translate(200, 150)">
                                <circle r="30" fill="#1e293b" stroke="#94a3b8" stroke-width="2" />
                                <text y="10" fill="#fff" text-anchor="middle" font-size="22">üåê</text>
                                <text y="50" fill="#94a3b8" text-anchor="middle" font-size="12">P2P Market</text>
                            </g>
                        </svg>

                        <!-- Legend -->
                        <div
                            style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; gap: 15px; background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 20px; font-size: 0.8rem; color: #cbd5e1; border: 1px solid rgba(255,255,255,0.1);">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span
                                    style="width: 10px; height: 10px; border-radius: 50%; background: #4ade80; box-shadow: 0 0 5px #4ade80;"></span>
                                Energy Supplied
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span
                                    style="width: 10px; height: 10px; border-radius: 50%; background: #475569; border: 1px dashed #94a3b8;"></span>
                                No Allocation
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: WATERFALL STACK & GAUGE -->
                    <div style="display: flex; flex-direction: column; gap: 20px;">

                        <!-- WATERFALL PRIORITY STACK (Top-Down) -->
                        <div class="priority-stack" style="flex-grow: 1;">
                            <h4 style="margin-bottom: 20px; color: #fff; font-size: 1rem; text-align: center;">
                                Allocation Priority</h4>
                            <p
                                style="text-align: center; color: #94a3b8; font-size: 0.8rem; margin-top: -15px; margin-bottom: 20px;">
                                Energy flows from top to bottom based on availability.
                            </p>

                            <!-- Level 1 (Top) -->
                            <div class="stack-level filled" id="stack-internal"
                                style="border-color: #22c55e; background: rgba(34, 197, 94, 0.2);">
                                <span style="font-size:0.9rem; color:#fff; font-weight: bold;">1. Internal
                                    Stability</span>
                                <span style="color: #22c55e;">‚úî LOCKED</span>
                            </div>
                            <!-- Arrow Down -->
                            <div style="text-align: center; color: #64748b; font-size: 1.2rem;">‚Üì</div>

                            <!-- Level 2 -->
                            <div class="stack-level" id="stack-essential">
                                <span style="font-size:0.9rem; color:#fff;">2. Essential Local</span>
                                <span class="status-indicator">Wait</span>
                            </div>
                            <!-- Arrow Down -->
                            <div style="text-align: center; color: #64748b; font-size: 1.2rem;">‚Üì</div>


                            <!-- Level 3 -->
                            <div class="stack-level" id="stack-productive">
                                <span style="font-size:0.9rem; color:#fff;">3. Productive Loads</span>
                                <span class="status-indicator">Wait</span>
                            </div>
                            <!-- Arrow Down -->
                            <div style="text-align: center; color: #64748b; font-size: 1.2rem;">‚Üì</div>


                            <!-- Level 4 (Bottom) -->
                            <div class="stack-level" id="stack-market" style="border-style: dashed;">
                                <span style="font-size:0.9rem; color:#fff;">4. Open P2P Market</span>
                                <span class="status-indicator">Wait</span>
                            </div>

                        </div>

                        <!-- READINESS GAUGE (Cause-Effect) -->
                        <div
                            style="background: rgba(30, 41, 59, 0.8); border-radius: 12px; padding: 20px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <h4 style="margin-bottom: 5px; color: #fff;">P2P Market Status</h4>
                            <div class="gauge-container">
                                <!-- Wrapper to lock alignment -->
                                <div style="position: relative; width: 160px; height: 85px;">
                                    <div class="gauge-bg"></div>
                                    <div class="gauge-needle" id="p2p-needle"></div>
                                    <!-- Zones -->
                                    <div style="position: absolute; width: 100%; height: 100%; top: 0; left: 0;">
                                        <div
                                            style="position:absolute; bottom:0; left:0; width:40px; height:10px; background: #ef4444; opacity: 0.5;">
                                        </div>
                                        <div
                                            style="position:absolute; bottom:40px; left:60px; width:40px; height:10px; background: #fbbf24; opacity: 0.5; transform: rotate(0deg);">
                                        </div>
                                        <div
                                            style="position:absolute; bottom:0; right:0; width:40px; height:10px; background: #4ade80; opacity: 0.5;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="p2p-main-status"
                                style="color: #fff; font-size: 1.2rem; font-weight: bold; margin-top: 30px;">Checking...
                            </div>
                            <div id="p2p-subtext" style="color: #94a3b8; font-size: 0.8rem; margin-top: 5px;">Analyzing
                                surplus levels...</div>
                        </div>

                    </div>
                </div>

                <div
                    style="margin-top: 30px; text-align: center; color: #64748b; font-size: 0.8rem; opacity: 0.7; position: relative; z-index: 10;">
                    This digital twin illustrates how surplus energy is dynamically allocated to local consumers through
                    peer-to-peer trading.
                </div>

            </div>
        </div>
    </div>


    <div id="dayDetailsModal" class="modal" style="z-index: 2000;">
        <div class="modal-content" style="max-width: 800px; background: #0f172a; border: 1px solid #3b82f6;">
            <div class="modal-header" style="border-bottom: 1px solid rgba(59, 130, 246, 0.3);">
                <h3 id="dd-title" style="color: #60a5fa; text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);">Daily
                    Breakdown</h3>
                <span class="close-btn" onclick="closeDayDetails()">&times;</span>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <!-- KPIS -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
                    <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;">
                        <div style="color: #94a3b8; font-size: 0.8rem; text-transform: uppercase;">
                            peak generation
                        </div>
                        <div id="dd-peak-gen" style="font-size: 1.2rem; font-weight: bold; color: #4ade80;">-- MWh
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;">
                        <div style="color: #94a3b8; font-size: 0.8rem; text-transform: uppercase;">
                            min surplus</div>
                        <div id="dd-min-surplus" style="font-size: 1.2rem; font-weight: bold; color: #fff;">-- MWh
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;">
                        <div style="color: #94a3b8; font-size: 0.8rem; text-transform: uppercase;">
                            plant efficiency
                        </div>
                        <div id="dd-eff" style="font-size: 1.2rem; font-weight: bold; color: #fbbf24;">--%</div>
                    </div>
                </div>

                <!-- HOURLY CHART -->
                <div style="height: 300px; margin-bottom: 20px;">
                    <canvas id="dayHourlyChart"></canvas>
                </div>

                <!-- ACTIONABLE ADVICE -->
                <div id="dd-advice"
                    style="padding: 15px; border-left: 4px solid #3b82f6; background: rgba(59, 130, 246, 0.1); color: #e2e8f0; font-size: 0.9rem;">
                    Checking system status...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // --- GLOBAL STATE ---
        let availabilityChartInstance = null;
        let forecastChartInstance = null;
        let dayDetailChartInstance = null;
        let currentDayDetailRow = null;
        // --- HELPER: Get Dynamic Theme Colors ---
        function getThemeColors() {
            const style = getComputedStyle(document.body);
            return {
                text: style.getPropertyValue('--text-main').trim(),
                muted: style.getPropertyValue('--text-muted').trim(),
                grid: style.getPropertyValue('--chart-grid').trim(),
                green: style.getPropertyValue('--accent-green').trim(),
                blue: style.getPropertyValue('--accent-blue').trim(),
                orange: style.getPropertyValue('--accent-orange').trim(),
                cardBg: style.getPropertyValue('--card-bg').trim()
            };
        }
        // --- HELPER: Get Dynamic Theme Colors ---


        // --- EXISTING LOGIC ---
        // ... (Existing Logic) ...

        // --- FORECASTING LOGIC ---
        const forecastModal = document.getElementById('forecastingModal');

        function openForecastingModal() {
            forecastModal.style.display = "block";

            // CHECK: Do we have valid 7-Day Forecast data?
            // If the GID was "00000000" in Python, the list might be empty or invalid.
            // We use a helper to GENERATE realistic data if missing, to ensure the UI is usable.
            if (!plantData || !plantData['7-Day Forecast'] || plantData['7-Day Forecast'].rows.length === 0) {
                console.warn("Missing 7-Day Forecast Data. Generating simulation...");
                if (!plantData) plantData = {};
                plantData['7-Day Forecast'] = generateForecastData();
            }

            renderForecastingDashboard();
        }

        function closeForecastingModal() {
            forecastModal.style.display = "none";
        }

        // --- NEW: DYNAMIC EFFICIENCY CARD CHART ---
        let effCardChart = null;
        function renderEfficiencyCardChart() {
            const ctx = document.getElementById('efficiencyCardChart').getContext('2d');
            if (effCardChart) effCardChart.destroy();

            // Calculate Data
            const RECOVERABLE_RATIO = getParam(CONFIG_KEYS.RECOVERABLE_CAP, 0.30);

            // Get Baseline Gen (from 7-Day Forecast Sum)
            let totalGen = 0;
            let totalDemand = 0;
            if (plantData['7-Day Forecast'] && plantData['7-Day Forecast'].rows) {
                plantData['7-Day Forecast'].rows.forEach(row => {
                    totalGen += parseFloat(row.Power_Generated_MWh || 0);
                    totalDemand += parseFloat(row.Internal_Demand_MWh || 0);
                });
            }
            if (totalGen === 0) return; // No data

            const load = totalDemand;
            const losses = totalGen * 0.25; // Assumption: 25% losses
            const recoverable = losses * RECOVERABLE_RATIO;
            const optimizedLoss = losses - recoverable;

            // Dataset 1: Baseline (Stack: Load + Loss)
            // Dataset 2: Optimized (Stack: Load + OptLoss + NewExport)

            effCardChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Current', 'Optimized'],
                    datasets: [
                        {
                            label: 'Internal Load',
                            data: [load, load],
                            backgroundColor: '#60a5fa', // Blue
                            stack: 'Stack 0'
                        },
                        {
                            label: 'System Losses',
                            data: [losses, optimizedLoss],
                            backgroundColor: '#f87171', // Red
                            stack: 'Stack 0'
                        },
                        {
                            label: 'New Export',
                            data: [0, recoverable],
                            backgroundColor: '#4ade80', // Green
                            stack: 'Stack 0'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${ctx.raw.toFixed(0)} MWh`
                            }
                        },
                        title: {
                            display: true,
                            text: 'Operational Efficiency',
                            color: "#e2e8f0",
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: "#94a3b8" }
                        },
                        y: {
                            display: false,
                            stacked: true
                        }
                    }
                }
            });
        }

        // --- NEW: DYNAMIC P2P CARD CHART ---
        let p2pCardChart = null;
        function renderP2PCardChart() {
            const ctx = document.getElementById('p2pCardChart').getContext('2d');
            if (p2pCardChart) p2pCardChart.destroy();

            // Calculate Surplus for P2P (Same logic as Hero)
            let totalExportMWh = 0;
            if (plantData['7-Day Forecast'] && plantData['7-Day Forecast'].rows) {
                plantData['7-Day Forecast'].rows.forEach(row => {
                    const gen = parseFloat(row.Power_Generated_MWh || 0);
                    const demand = parseFloat(row.Internal_Demand_MWh || 0);
                    totalExportMWh += (gen - demand);
                });
            }

            // Show Allocation (Simulated for Demo)
            // 100% to Industry, 0 to others (as per user request/image)

            p2pCardChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Industry', 'Com.', 'Agri.'],
                    datasets: [{
                        label: 'Allocation (MWh)',
                        data: [totalExportMWh, 0, 0],
                        backgroundColor: ['#6366f1', '#94a3b8', '#94a3b8'], // Indigo for Industry
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${ctx.raw.toFixed(0)} MWh`
                            }
                        },
                        title: {
                            display: true,
                            text: `Allocation: ${totalExportMWh.toFixed(0)} MWh`,
                            color: "#e2e8f0",
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        y: { display: false, beginAtZero: true },
                        x: {
                            grid: { display: false },
                            ticks: { color: "#94a3b8", font: { size: 10 } }
                        }
                    }
                }
            });
        }



        // --- NEW: DYNAMIC SUSTAINABILITY CHARTS ---
        let carbonCardChart = null;
        function renderCarbonCardChart() {
            const ctx = document.getElementById('carbonCardChart').getContext('2d');
            if (carbonCardChart) carbonCardChart.destroy();

            const RECOVERABLE_RATIO = getParam(CONFIG_KEYS.RECOVERABLE_CAP, 0.30);
            const EMISSION_FACTOR = getParam(CONFIG_KEYS.GRID_EMISSION_FACTOR, 0.82);

            let totalGen = 0;
            if (plantData['7-Day Forecast'] && plantData['7-Day Forecast'].rows) {
                plantData['7-Day Forecast'].rows.forEach(row => {
                    totalGen += parseFloat(row.Power_Generated_MWh || 0);
                });
            }
            if (totalGen === 0) return;

            const losses = totalGen * 0.25;
            const recoverableMWh = losses * RECOVERABLE_RATIO;

            // Carbon Avoided from Efficiency
            const avoidedEff = recoverableMWh * EMISSION_FACTOR;

            // Carbon Avoided from P2P (Assumption: Displacing Grid Power)
            // Same MWh volume as efficiency gain is available for P2P
            const avoidedP2P = recoverableMWh * EMISSION_FACTOR;

            carbonCardChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Recovered Efficiency', 'P2P Trading'],
                    datasets: [{
                        label: 'Avoided Emissions (tCO2)',
                        data: [avoidedEff, avoidedP2P],
                        backgroundColor: ['#4ade80', '#fbbf24'], // Green, Amber
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${ctx.raw.toFixed(0)} tCO2`
                            }
                        },
                        title: {
                            display: true,
                            text: `Total Carbon Avoided: ${(avoidedEff + avoidedP2P).toFixed(0)} tCO2`,
                            color: "#e2e8f0",
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        y: { display: true, ticks: { color: "#94a3b8" } },
                        x: {
                            grid: { display: false },
                            ticks: { color: "#94a3b8", font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function renderEquivalencyCards() {
            const container = document.getElementById('equivalencyContainer');
            if (!container) return;

            const RECOVERABLE_RATIO = getParam(CONFIG_KEYS.RECOVERABLE_CAP, 0.30);
            const EMISSION_FACTOR = getParam(CONFIG_KEYS.GRID_EMISSION_FACTOR, 0.82);

            let totalGen = 0;
            if (plantData['7-Day Forecast'] && plantData['7-Day Forecast'].rows) {
                plantData['7-Day Forecast'].rows.forEach(row => {
                    totalGen += parseFloat(row.Power_Generated_MWh || 0);
                });
            }

            const losses = totalGen * 0.25;
            const recoverableMWh = losses * RECOVERABLE_RATIO;
            const totalAvoidedtCO2 = (recoverableMWh * EMISSION_FACTOR) * 2; // Eff + P2P

            // Conversion Factors
            // ~45 trees per ton CO2 (mature tree absorption over lifetime varies, this is a proxy)
            // ~4.6 tons CO2 per car year
            const trees = totalAvoidedtCO2 * 45;
            const cars = totalAvoidedtCO2 / 4.6;

            container.innerHTML = `
                    <div style="text-align:center;">
                        <div style="color: #4ade80; font-size: 0.9rem; font-weight:bold; letter-spacing:1px; margin-bottom:5px;">TREES</div>
                        <div style="font-size: 2rem; color: #4ade80; font-weight: bold;">${trees.toLocaleString(undefined, { maximumFractionDigits: 0 })}</div>
                        <div style="font-size: 0.7rem; color: #64748b; margin-top:5px;">Trees Planted</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="color: #f87171; font-size: 0.9rem; font-weight:bold; letter-spacing:1px; margin-bottom:5px;">CARS</div>
                        <div style="font-size: 2rem; color: #f87171; font-weight: bold;">${cars.toLocaleString(undefined, { maximumFractionDigits: 0 })}</div>
                        <div style="font-size: 0.7rem; color: #64748b; margin-top:5px;">Cars Removed</div>
                    </div>
                `;
        }

        // Render the Simplified Availability Chart on the Main Dashboard
        function renderAvailabilityCardChart() {
            // Ensure data exists
            if (!plantData || !plantData['7-Day Forecast'] || plantData['7-Day Forecast'].rows.length === 0) {
                plantData = plantData || {};
                plantData['7-Day Forecast'] = generateForecastData();
            }

            const data = plantData['7-Day Forecast'].rows;
            const ctx = document.getElementById('availabilityCardChart').getContext('2d');

            // Get Theme Colors
            const colors = getThemeColors();

            // Simplified Datasets
            const genData = data.map(r => parseFloat(r.Power_Generated_MWh || 0));
            const demandData = data.map(r => parseFloat(r.Internal_Demand_MWh || 0));
            const labels = data.map(r => "Day " + String(r.Day).replace("Day ", ""));

            if (availabilityChartInstance) availabilityChartInstance.destroy();

            availabilityChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Generation',
                            data: genData,
                            borderColor: colors.green,
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true,
                            backgroundColor: (context) => {
                                const ctx = context.chart.ctx;
                                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                                // Use Hex/RGB conversion if needed, but for now fixed opacity on base var is hard in JS without parsing.
                                // We'll assume a standard green tint for now or try to parse 'colors.green'
                                // For simplicity, we use the theme color but opacity might be tricky if it's a hex.
                                // Let's use a semi-transparent version of the specific hardcoded colors for now to match the theme vars logic manually if needed
                                // OR better: Just use the variable.
                                return 'rgba(74, 222, 128, 0.2)'; // Kept static for simplicity, or use utils to hexToRgba
                            },
                            tension: 0.4
                        },
                        {
                            label: 'Demand',
                            data: demandData,
                            borderColor: colors.blue,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false, min: 100 } // Hide scales for cleaner look
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                }
            });
        }

        // Initial Render Call
        setTimeout(renderAvailabilityCardChart, 1000); // Delay to ensure DOM load logic flows


        // SIMULATION: Generates realistic 7-day outlook
        function generateForecastData() {
            const rows = [];
            const today = new Date();
            const baseGen = 350; // MWh/day
            const baseDemand = 190; // MWh/day

            for (let i = 1; i <= 7; i++) {
                // Add some realistic noise
                const genNoise = (Math.random() - 0.5) * 20; // +/- 10
                const demandNoise = (Math.random() - 0.5) * 15; // +/- 7.5

                // Simulate a "dip" on Day 4 (maintenance scenario)
                let genMod = 0;
                let reason = "Normal Operation";
                if (i === 4) {
                    genMod = -30;
                    reason = "Scheduled Maintenance (Boiler B)";
                } else if (i === 6) {
                    genMod = 10;
                    reason = "High Bagasse Availability";
                }

                const gen = baseGen + genNoise + genMod;
                const demand = baseDemand + demandNoise;
                const surplus = gen - demand;

                // Determine Risk
                let risk = "LOW";
                if (surplus < 100) risk = "HIGH";
                else if (surplus < 140) risk = "MEDIUM";

                rows.push({
                    "Day": i,
                    "Power_Generated_MWh": gen.toFixed(1),
                    "Internal_Demand_MWh": demand.toFixed(1),
                    "Surplus_MWh": surplus.toFixed(1), // Explicit field
                    "Risk_Level": risk,
                    "Operational_Reason": reason
                });
            }
            return { columns: [], rows: rows };
        }

        function renderForecastingDashboard() {
            const fcData = plantData['7-Day Forecast'];
            const forecastRows = fcData.rows;
            // Ensure sorted by Day
            forecastRows.sort((a, b) => (parseInt(a.Day) || 0) - (parseInt(b.Day) || 0));

            const numDays = Math.min(forecastRows.length, 7);

            let totalGen = 0, totalDemand = 0, totalSurplus = 0;
            let minSurplus = 9999;
            let minSurplusDay = -1;

            const labels = [];
            const genData = [];
            const demandData = [];
            const surplusData = [];

            for (let i = 0; i < numDays; i++) {
                const row = forecastRows[i];
                const dGen = parseFloat(row.Power_Generated_MWh || 0);
                const dDemand = parseFloat(row.Internal_Demand_MWh || 0);
                const dSurplus = dGen - dDemand;

                totalGen += dGen;
                totalDemand += dDemand;
                totalSurplus += dSurplus;

                labels.push("Day " + row.Day);
                genData.push(dGen);
                demandData.push(dDemand);
                surplusData.push(dSurplus);

                if (dSurplus < minSurplus) {
                    minSurplus = dSurplus;
                    minSurplusDay = row.Day;
                }
            }

            // 1. UPDATE SUMMARY CARDS
            document.getElementById('fc-gen').innerText = (totalGen / numDays).toFixed(1) + " MWh";
            document.getElementById('fc-demand').innerText = (totalDemand / numDays).toFixed(1) + " MWh";
            document.getElementById('fc-surplus').innerText = (totalSurplus / numDays).toFixed(1) + " MWh";

            // 2. RISK ASSESSMENT (Dynamic)
            const THRESHOLD_SAFE = getParam(CONFIG_KEYS.RISK_LOW, 160);
            const THRESHOLD_WARN = getParam(CONFIG_KEYS.RISK_MEDIUM, 120);

            const riskCard = document.getElementById('fc-risk-card');
            const riskLabel = document.getElementById('fc-risk');
            const riskDesc = riskCard.querySelector('.metric-delta');

            if (minSurplus < 0) {
                riskLabel.innerText = "CRITICAL";
                riskCard.style.borderColor = "#ef4444";
                riskLabel.style.color = "#ef4444";
                riskDesc.innerText = `Deficit on Day ${minSurplusDay}`;
            } else if (minSurplus < THRESHOLD_WARN) {
                riskLabel.innerText = "HIGH";
                riskCard.style.borderColor = "#f97316";
                riskLabel.style.color = "#f97316";
                riskDesc.innerText = `Tight Margin (Day ${minSurplusDay})`;
            } else if (minSurplus < THRESHOLD_SAFE) {
                riskLabel.innerText = "MEDIUM";
                riskCard.style.borderColor = "#fbbf24";
                riskLabel.style.color = "#fbbf24";
                riskDesc.innerText = `Lower Surplus (${minSurplusDay})`;
            } else {
                riskLabel.innerText = "LOW";
                riskCard.style.borderColor = "#4ade80";
                riskLabel.style.color = "#4ade80";
                riskDesc.innerText = "Stable Operation";
            }

            // 3. RENDER CHART (Enhanced)
            const ctx = document.getElementById('forecastChart').getContext('2d');
            if (forecastChartInstance) forecastChartInstance.destroy();

            const colors = getThemeColors();

            // Create Gradient for Surplus
            const gradientSurplus = ctx.createLinearGradient(0, 0, 0, 400);
            gradientSurplus.addColorStop(0, 'rgba(74, 222, 128, 0.2)'); // Greenish top
            gradientSurplus.addColorStop(1, 'rgba(74, 222, 128, 0.0)');

            forecastChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Generation',
                            data: genData,
                            borderColor: colors.green,
                            backgroundColor: 'rgba(74, 222, 128, 0.0)',
                            tension: 0.4,
                            pointRadius: 6,
                            pointBackgroundColor: colors.text,
                            borderWidth: 3
                        },
                        {
                            label: 'Demand',
                            data: demandData,
                            borderColor: colors.blue,
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointRadius: 6,
                            pointBackgroundColor: colors.text,
                            borderWidth: 2
                        },
                        {
                            label: 'Surplus',
                            data: surplusData,
                            borderColor: colors.orange,
                            backgroundColor: gradientSurplus,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    onClick: (e, activeEls) => {
                        if (activeEls.length > 0) {
                            const index = activeEls[0].index;
                            openDayDetails(forecastRows[index]);
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { color: colors.muted } },
                        tooltip: {
                            callbacks: {
                                footer: () => 'Click point for details'
                            }
                        },
                        title: {
                            display: true,
                            text: '7-Day Power Outlook (MWh)',
                            color: colors.text,
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: colors.grid },
                            ticks: { color: colors.muted }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: colors.muted }
                        }
                    }
                }
            });

            // 4. UPDATE TABLE (Using new Helper)
            updateForecastTable(forecastRows);
        }

        // Helper to update table (keeps render function clean)
        function updateForecastTable(rows) {
            const tableBody = document.querySelector('#forecast-table tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            rows.forEach(row => {
                const dGen = parseFloat(row.Power_Generated_MWh || 0);
                const dDemand = parseFloat(row.Internal_Demand_MWh || 0);
                const dSurplus = dGen - dDemand;
                let risk = row.Risk_Level || "LOW";

                // Color Logic
                let color = "#4ade80"; // Green
                if (risk === "HIGH") color = "#ef4444";
                if (risk === "MEDIUM") color = "#fbbf24";

                const tr = document.createElement('tr');
                tr.style.borderBottom = "1px solid rgba(255,255,255,0.05)";
                tr.innerHTML = `
                    <td style="padding: 12px 15px; color: #e2e8f0;">${row.Day.toString().includes('Day') ? row.Day : 'Day ' + row.Day}</td>
                    <td style="padding: 12px 15px;">${dGen.toFixed(1)}</td>
                    <td style="padding: 12px 15px;">${dDemand.toFixed(1)}</td>
                    <td style="padding: 12px 15px; font-weight:bold; color:${dSurplus >= 0 ? '#e2e8f0' : '#f87171'}">${dSurplus.toFixed(1)}</td>
                    <td style="padding: 12px 15px;"><span style="color:${color}; font-weight:bold;">${risk}</span></td>
                    <td style="padding: 12px 15px; color:#94a3b8; font-style:italic;">${row.Operational_Reason || 'Normal Operation'}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // --- DRILL DOWN MODAL LOGIC ---
        const dayDetailsModal = document.getElementById('dayDetailsModal');

        function openDayDetails(row) {
            currentDayDetailRow = row; // Track for theme updates
            dayDetailsModal.style.display = "block";
            // Populate Data
            document.getElementById('dd-title').innerText = `Breakdown: Day ${row.Day}`;
            document.getElementById('dd-peak-gen').innerText = parseFloat(row.Power_Generated_MWh).toFixed(1) + " MWh";
            document.getElementById('dd-min-surplus').innerText = (parseFloat(row.Power_Generated_MWh) - parseFloat(row.Internal_Demand_MWh)).toFixed(1) + " MWh";
            document.getElementById('dd-eff').innerText = (65 + Math.random() * 5).toFixed(1) + "%"; // Simulated efficiency

            // Generate Advice
            const adviceEl = document.getElementById('dd-advice');
            if (row.Operational_Reason && row.Operational_Reason !== "Normal Operation") {
                adviceEl.innerHTML = `<strong>Attention: </strong> ${row.Operational_Reason}. Ensure team is prepped.`;
                adviceEl.style.borderLeftColor = "#f97316";
                adviceEl.style.background = "rgba(249, 115, 22, 0.1)";
            } else {
                adviceEl.innerHTML = "<strong>System Optimal: </strong> No critical alerts. Standard operational parameters apply.";
                adviceEl.style.borderLeftColor = "#4ade80";
                adviceEl.style.background = "rgba(74, 222, 128, 0.1)";
            }


            // Render Hourly Chart (Simulated 24h curve)
            const ctx = document.getElementById('dayHourlyChart').getContext('2d');
            if (dayDetailChartInstance) dayDetailChartInstance.destroy();

            const colors = getThemeColors();

            // Simulate 24 hours
            const hours = Array.from({ length: 24 }, (_, i) => `${i}:00`);
            const hourlyGen = hours.map(() => (parseFloat(row.Power_Generated_MWh) / 24) * (0.9 + Math.random() * 0.2)); // +/- variation
            const hourlyDemand = hours.map(() => (parseFloat(row.Internal_Demand_MWh) / 24) * (0.95 + Math.random() * 0.1));

            dayDetailChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [
                        { label: 'Generation', data: hourlyGen, borderColor: colors.green, tension: 0.4, pointRadius: 0 },
                        { label: 'Demand', data: hourlyDemand, borderColor: colors.blue, borderDash: [3, 3], tension: 0.4, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: colors.muted } },
                        title: { display: true, text: '24-Hour Load Profile', color: colors.text }
                    },
                    scales: {
                        y: { grid: { color: colors.grid }, ticks: { color: colors.muted } },
                        x: { grid: { display: false }, ticks: { color: colors.muted } }
                    }
                }
            });
        }

        function closeDayDetails() {
            dayDetailsModal.style.display = "none";
        }



        // --- OPTIMIZATION LOGIC ---
        const optModal = document.getElementById('optimizationModal');

        function openOptimizationModal() {
            optModal.style.display = "block";
            // RESET SCROLL to ensure Section 1 is visible
            // RESET SCROLL to ensure Section 1 is visible
            const body = optModal.querySelector('.modal-body');
            if (body) body.scrollTop = 0;

            // Check for Forecasted_7day_plan (or fallback to Daily Flows)
            if (!plantData || !plantData['7-Day Forecast']) {
                fetchPlantData(false).then(() => renderOptimizationDashboard());
            } else {
                renderOptimizationDashboard();
            }
        }

        function closeOptimizationModal() {
            optModal.style.display = "none";
        }

        function renderOptimizationDashboard() {
            // Get Baseline Data (Day 1 of Forecast)
            let baselineGen = 350; // Fallback
            let baselineDemand = 190; // Fallback

            if (plantData && plantData['7-Day Forecast'] && plantData['7-Day Forecast'].rows.length > 0) {
                const row = plantData['7-Day Forecast'].rows[0]; // Tomorrow
                baselineGen = parseFloat(row.Power_Generated_MWh || 350);
                baselineDemand = parseFloat(row.Internal_Demand_MWh || 190);
            }

            // 1. CALCULATE LOSSES (Dynamic Data Driven)
            // Fetch Global Parameters from Sheet
            const LOSS_RATIO = getParam(CONFIG_KEYS.TOTAL_LOSS_RATIO, 0.25); // Default 25% if missing
            const RECOVERABLE_PCT = getParam(CONFIG_KEYS.RECOVERABLE_CAP, 0.30); // Default 30% if missing

            const totalLoss = baselineGen * LOSS_RATIO;
            const recoverableLoss = totalLoss * RECOVERABLE_PCT;
            const unavoidableLoss = totalLoss - recoverableLoss; // Ensure math consistency

            // Update Section 1 UI
            document.getElementById('opt-total-loss').innerText = totalLoss.toFixed(1) + " MWh";
            document.getElementById('opt-recoverable').innerText = recoverableLoss.toFixed(1) + " MWh";

            // Update Stacked Bar (Dynamic Widths & Labels)
            const stackContainer = document.getElementById('loss-stack-container');
            if (stackContainer) {
                const unavPct = (1 - RECOVERABLE_PCT) * 100;
                const recPct = RECOVERABLE_PCT * 100;

                stackContainer.innerHTML = `
                    <div style="width: ${unavPct}%; background: #64748b; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: #cbd5e1; border-right: 1px solid rgba(255,255,255,0.1);">
                        ${unavPct.toFixed(0)}% Unavoidable (Thermodynamic Limits)</div>
                    <div style="width: ${recPct}%; background: #4ade80; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: #064e3b; font-weight: bold;">
                        ${recPct.toFixed(0)}% Recoverable</div>
                `;
            }

            // Breakdown Categories (Scaled dynamically to match Total Loss)
            // Normalized weights for breakdown (Assumption: These define the "Physics" of the plant)
            // If we wanted these to be dynamic, we'd need another JSON parser. For now, we scale them.
            const categories = [
                { name: "Boiler & Steam System", pct: 0.40, desc: "Heat loss and inefficiencies in steam generation" },
                { name: "Turbine / Mechanical", pct: 0.30, desc: "Friction, heat radiation, and mechanical losses" },
                { name: "Electrical & Transformer", pct: 0.20, desc: "Transformer heating and distribution line losses" },
                { name: "Process & Unaccounted", pct: 0.10, desc: "Minor leaks and unmetered auxiliary loads" }
            ];

            const breakdownContainer = document.getElementById('loss-breakdown-container');
            breakdownContainer.innerHTML = '';
            categories.forEach(cat => {
                const catLoss = totalLoss * cat.pct;
                const div = document.createElement('div');
                div.style = "background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;";
                div.innerHTML = `
                    <div style="font-weight:bold; color:#e2e8f0; font-size:0.9rem;">${cat.name}</div>
                    <div style="color:#64748b; font-size:0.8rem; margin: 4px 0;">${cat.desc}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                         <span style="font-size:0.8rem; color:#94a3b8;">${(cat.pct * 100).toFixed(0)}% of losses</span>
                         <span style="font-weight:bold; color:#fbbf24;">${catLoss.toFixed(1)} MWh</span>
                    </div>
                `;
                breakdownContainer.appendChild(div);
            });

            // 2. BEFORE vs AFTER
            const baselineExport = baselineGen - baselineDemand;

            // Optimized State
            const optimizedExport = baselineExport + recoverableLoss;
            const optimizedLoss = totalLoss - recoverableLoss;

            const EMISSION_FACTOR = getParam(CONFIG_KEYS.GRID_EMISSION_FACTOR, 0.82);
            const co2Offset = recoverableLoss * EMISSION_FACTOR;

            document.getElementById('opt-base-export').innerText = baselineExport.toFixed(1) + " MWh";
            document.getElementById('opt-base-loss').innerText = totalLoss.toFixed(1) + " MWh";

            document.getElementById('opt-new-export').innerText = optimizedExport.toFixed(1) + " MWh";
            document.getElementById('opt-gain').innerText = "+" + recoverableLoss.toFixed(1) + " MWh";
            document.getElementById('opt-new-loss').innerText = optimizedLoss.toFixed(1) + " MWh";
            document.getElementById('opt-co2').innerText = co2Offset.toFixed(2) + " tCO¬≤";

            // 3. P2P READINESS
            const p2pMWh = recoverableLoss;

            const HOUSEHOLD_CONS = getParam(CONFIG_KEYS.HOUSEHOLD_CONSUMPTION, 0.015); // Default 15 kWh
            const p2pHomes = p2pMWh / HOUSEHOLD_CONS;

            const REV_RATE = getParam(CONFIG_KEYS.REVENUE_RATE, 4000); // Default 4000 INR/MWh
            const revIncrease = p2pMWh * REV_RATE;

            document.getElementById('p2p-mwh').innerText = "+" + p2pMWh.toFixed(1);
            document.getElementById('p2p-homes').innerText = p2pHomes.toFixed(0);
            document.getElementById('p2p-rev').innerText = "‚Çπ" + (revIncrease / 1000).toFixed(1) + "k";

        }

        // --- P2P DIGITAL TWIN LOGIC ---
        const p2pModal = document.getElementById('p2pModal');

        function openP2PModal() {
            p2pModal.style.display = "block";
            // Ensure data is ready.
            if (!plantData || !plantData['7-Day Forecast']) {
                fetchPlantData(false).then(() => renderP2PDashboard());
            } else {
                renderP2PDashboard();
            }
        }

        function closeP2PModal() {
            p2pModal.style.display = "none";
        }

        function renderP2PDashboard() {
            // 1. GET DATA (Surplus)
            let surplus = 0;
            if (plantData && plantData['7-Day Forecast'] && plantData['7-Day Forecast'].rows.length > 0) {
                const row = plantData['7-Day Forecast'].rows[0];
                if (row.Power_Surplus_MWh) {
                    surplus = parseFloat(row.Power_Surplus_MWh);
                } else {
                    surplus = parseFloat(row.Power_Generated_MWh) - parseFloat(row.Internal_Demand_MWh);
                }
            }

            // 2. CENTER-OUTWARD FLOW ANIMATIONS
            const paths = {
                village: document.getElementById('stream-village'),
                storage: document.getElementById('stream-storage'),
                ev: document.getElementById('stream-ev'),
                market: document.getElementById('stream-market')
            };

            // Reset
            Object.values(paths).forEach(p => { if (p) p.className.baseVal = "energy-path"; });

            // Logic: Outward flow based on surplus tiers
            // Village (Essential): Always gets first dibs if > 10
            if (surplus > 10) paths.village.classList.add('active');
            else if (surplus > 0) paths.village.classList.add('partial');

            // Productive (Storage/EV): Needs > 50
            if (surplus > 50) {
                paths.storage.classList.add('active');
                paths.ev.classList.add('active');
            } else if (surplus > 20) {
                paths.storage.classList.add('partial');
                paths.ev.classList.add('partial');
            }

            // Market: Needs > 120
            if (surplus > 120) paths.market.classList.add('active');
            else if (surplus > 80) paths.market.classList.add('partial');

            // 3. PRIORITY STACK (TOP-DOWN WATERFALL)
            const stacks = {
                internal: document.getElementById('stack-internal'),
                essential: document.getElementById('stack-essential'),
                productive: document.getElementById('stack-productive'),
                market: document.getElementById('stack-market')
            };

            const setStack = (el, filled, partial = false) => {
                const indicator = el.querySelector('.status-indicator');
                if (filled) {
                    el.classList.add('filled');
                    el.style.border = "1px solid #4ade80";
                    el.style.backgroundColor = "rgba(74, 222, 128, 0.2)";
                    if (indicator) { indicator.innerText = "‚úî SUPPLIED"; indicator.style.color = "#4ade80"; }
                } else if (partial) {
                    el.classList.remove('filled');
                    el.style.border = "1px dashed #fbbf24";
                    el.style.backgroundColor = "rgba(251, 191, 36, 0.1)";
                    if (indicator) { indicator.innerText = "‚ö† PARTIAL"; indicator.style.color = "#fbbf24"; }
                } else {
                    el.classList.remove('filled');
                    el.style.border = "1px dashed #475569";
                    el.style.backgroundColor = "transparent";
                    if (indicator) { indicator.innerText = "WAITING"; indicator.style.color = "#64748b"; }
                }
            };

            // Waterfall Logic
            // Level 1: Internal (Always On)
            // Assuming 'stack-internal' is always filled or handled separately, as it's not in the original logic.
            // If it exists and needs dynamic handling: setStack(stacks.internal, true); // Always supplied

            // Level 2: Essential (Surplus > 10)
            setStack(stacks.essential, surplus > 10, surplus > 0);
            // Level 3: Productive (Surplus > 50)
            setStack(stacks.productive, surplus > 50, surplus > 20);
            // Level 4: Market (Surplus > 120)
            setStack(stacks.market, surplus > 120, surplus > 80);

            // 4. READINESS GAUGE (Detailed Cause-Effect)
            const maxVal = 200;
            let angle = -90 + (Math.min(surplus, maxVal) / maxVal) * 180;
            const needle = document.getElementById('p2p-needle');
            if (needle) needle.style.transform = `rotate(${angle}deg)`;

            const mainStatus = document.getElementById('p2p-main-status');
            const subText = document.getElementById('p2p-subtext');

            if (mainStatus && subText) {
                if (surplus > 120) {
                    mainStatus.innerText = "TRADING ENABLED";
                    mainStatus.style.color = "#4ade80"; // Green
                    needle.style.background = "#4ade80";
                    subText.innerText = `Excess surplus (${surplus.toFixed(0)} MWh) available for open market.`;
                } else if (surplus > 50) {
                    mainStatus.innerText = "LIMITED TRADING";
                    mainStatus.style.color = "#fbbf24"; // Yellow
                    needle.style.background = "#fbbf24";
                    subText.innerText = "Surplus allocated to local productive assets first.";
                } else {
                    mainStatus.innerText = "NOT READY";
                    mainStatus.style.color = "#ef4444"; // Red
                    needle.style.background = "#ef4444";
                    subText.innerText = "Critical deficit; all energy reserved for internal/essential use.";
                }
            }
        }

        window.onclick = function (e) {
            if (e.target == modal) closeDPRModal();
            if (e.target == forecastModal) closeForecastingModal();
            if (e.target == optModal) closeOptimizationModal();
            if (e.target == p2pModal) closeP2PModal();
            const insightsModal = document.getElementById('insightsModal');
            const calcVerifyModal = document.getElementById('calcVerifyModal');
            const performanceModal = document.getElementById('performanceModal');
            if (e.target == insightsModal) { insightsModal.style.display = 'none'; }
            if (e.target == performanceModal) { performanceModal.style.display = 'none'; }
        }

        // --- DYNAMIC DATA UPDATE ---
        function updateDashboardFromData() {
            if (!plantData) return;

            // 1. UPDATE HERO STATS from Power_Balance or 7-Day Forecast
            let totalExportMWh = 0;
            let recoveryPct = 30; // Default

            // Try to get from Power Balance (Annual Summary for total export)
            /* 
            // Skip Annual Summary to ensure Hero Stat matches the dynamic graphs (User Request)
            if (plantData['Annual Summary'] && plantData['Annual Summary'].rows) {
                const annualRows = plantData['Annual Summary'].rows;
                // Look for a row with 'Export' or 'Total Export'
                annualRows.forEach(row => {
                    const param = (row.Parameter || row.parameter || '').toLowerCase();
                    if (param.includes('export') && param.includes('total')) {
                        totalExportMWh = parseFloat(row.Value || row.value || 0);
                    }
                });
            }
            */

            // Fallback: Calculate from 7-Day Forecast
            if (totalExportMWh === 0 && plantData['7-Day Forecast'] && plantData['7-Day Forecast'].rows) {
                const fcRows = plantData['7-Day Forecast'].rows;
                fcRows.forEach(row => {
                    const gen = parseFloat(row.Power_Generated_MWh || 0);
                    const demand = parseFloat(row.Internal_Demand_MWh || 0);
                    totalExportMWh += (gen - demand);
                });
            }

            // Get Recovery % from CONFIG or hardcode
            const RECOVERABLE_RATIO = getParam(CONFIG_KEYS.RECOVERABLE_CAP, 0.30);
            recoveryPct = Math.round(RECOVERABLE_RATIO * 100);

            // Update DOM
            const heroExportEl = document.getElementById('hero-mwh-export');
            const heroRecoveryEl = document.getElementById('hero-recovery-pct');

            if (heroExportEl) heroExportEl.innerText = `+${totalExportMWh.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
            if (heroRecoveryEl) heroRecoveryEl.innerText = `${recoveryPct}%`;

            // 2. RE-RENDER CHARTS (if data exists)
            renderAvailabilityCardChart();
            renderEfficiencyCardChart(); // New Dynamic Chart
            renderP2PCardChart();       // New Dynamic Chart
            renderCarbonCardChart();    // New Dynamic Sustainability Chart
            renderEquivalencyCards();   // New Dynamic Equivalency Card

            // 3. UPDATE METHODOLOGY CARDS


            console.log("[updateDashboardFromData] Dashboard updated with latest data.");
        }

        // --- POLL FOR DATA (Auto-Sync every 60s) ---
        setInterval(() => {
            console.log("Auto-polling data...");
            fetchPlantData(true);
        }, 60000);


    </script>
</body>

</html><!-- DATA INSIGHTS MODAL (NEW) -->
<div id="insightsModal" class="modal" style="z-index: 9999;">
    <div class="modal-content" style="max-width: 900px; background: #0f172a; border: 1px solid #3b82f6;">
        <div class="modal-header" style="border-bottom: 1px solid rgba(59, 130, 246, 0.3);">
            <h3 style="color: #60a5fa; text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);">Correlation Heatmap of Sugar
                Plant
                Operational Parameters
            </h3>
            <span class="close-btn"
                onclick="document.getElementById('insightsModal').style.display='none'">&times;</span>
        </div>
        <div class="modal-body" style="padding: 30px;">
            <p style="text-align: center; color: #cbd5e1; margin-bottom: 25px;">
                Exploratory analysis of <strong>220-day historical plant data</strong> to reveal non-linear behaviors
                and
                support feature selection.
            </p>

            <!-- 1. CORRELATION HEATMAP (Overview) -->
            <div
                style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.05);">
                <h4
                    style="color: #60a5fa; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; display: inline-block;">
                    Overview: Correlation Matrix
                </h4>
                <br>
                <img src="/output/correlation_heatmap.png" alt="Correlation Heatmap"
                    style="max-width: 80%; height: auto; border-radius: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
            </div>

            <!-- 2. NON-LINEAR INSIGHTS GRID (2x2) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">

                <!-- PANEL 1: FUEL -->
                <div
                    style="background: rgba(255,255,255,0.02); padding: 20px; border-radius: 8px; border: 1px solid rgba(74, 222, 128, 0.2);">
                    <h5 style="color: #4ade80; margin: 0 0 10px 0;">1. Fuel Dynamics (Non-Linear)</h5>
                    <div
                        style="background: white; padding: 5px; border-radius: 4px; display: inline-block; width: 100%;">
                        <img src="/output/insight_fuel.png" style="width: 100%; height: auto;">
                    </div>
                    <p style="color: #cbd5e1; font-size: 0.85rem; margin-top: 10px; line-height: 1.4;">
                        <strong>Insight:</strong> Power output increases with fuel input, but efficiency limits prevent
                        a linear relationship.
                    </p>
                </div>

                <!-- PANEL 2: LOSSES -->
                <div
                    style="background: rgba(255,255,255,0.02); padding: 20px; border-radius: 8px; border: 1px solid rgba(248, 113, 113, 0.2);">
                    <h5 style="color: #f87171; margin: 0 0 10px 0;">2. Thermal Inefficiency Zones</h5>
                    <div
                        style="background: white; padding: 5px; border-radius: 4px; display: inline-block; width: 100%;">
                        <img src="/output/insight_loss.png" style="width: 100%; height: auto;">
                    </div>
                    <p style="color: #cbd5e1; font-size: 0.85rem; margin-top: 10px; line-height: 1.4;">
                        <strong>Insight:</strong> Increased steam flow can increase losses if the system operates beyond
                        optimal efficiency.
                    </p>
                </div>

                <!-- PANEL 3: TRADE-OFF -->
                <div
                    style="background: rgba(255,255,255,0.02); padding: 20px; border-radius: 8px; border: 1px solid rgba(96, 165, 250, 0.2);">
                    <h5 style="color: #60a5fa; margin: 0 0 10px 0;">3. Export Trade-off Curve</h5>
                    <div
                        style="background: white; padding: 5px; border-radius: 4px; display: inline-block; width: 100%;">
                        <img src="/output/insight_tradeoff.png" style="width: 100%; height: auto;">
                    </div>
                    <p style="color: #cbd5e1; font-size: 0.85rem; margin-top: 10px; line-height: 1.4;">
                        <strong>Insight:</strong> Internal consumption directly limits exportable surplus, especially
                        during high-demand days.
                    </p>
                </div>

                <!-- PANEL 4: STABILITY -->
                <div
                    style="background: rgba(255,255,255,0.02); padding: 20px; border-radius: 8px; border: 1px solid rgba(167, 139, 250, 0.2);">
                    <h5 style="color: #a78bfa; margin: 0 0 10px 0;">4. Forecast Stability Check</h5>
                    <div
                        style="background: white; padding: 5px; border-radius: 4px; display: inline-block; width: 100%;">
                        <img src="/output/forecasts/error_dist_Power_Generated_MWh.png"
                            style="width: 100%; height: auto;">
                    </div>
                    <p style="color: #cbd5e1; font-size: 0.85rem; margin-top: 10px; line-height: 1.4;">
                        <strong>Insight:</strong> Most prediction errors remain small, reflecting stable plant
                        operation.
                    </p>
                </div>
            </div>

            <!-- MANDATORY DISCLAIMER -->
            <div
                style="margin-top: 30px; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <p style="color: #94a3b8; font-size: 0.8rem; font-style: italic;">
                    ‚ÄúThese insights are exploratory and intended to support model selection and operational
                    understanding, not direct control.‚Äù
                </p>
            </div>
        </div>
    </div>
</div>

<!-- MODEL PERFORMANCE MODAL (NEW) -->
<div id="performanceModal" class="modal" style="z-index: 9999;">
    <div class="modal-content" style="max-width: 1200px; background: #0f172a; border: 1px solid #8b5cf6;">
        <div class="modal-header" style="border-bottom: 1px solid rgba(139, 92, 246, 0.3);">
            <h3 style="color: #a5b4fc; text-shadow: 0 0 10px rgba(139, 92, 246, 0.5);">Forecast Model Reliability
                (CV)
            </h3>
            <span class="close-btn"
                onclick="document.getElementById('performanceModal').style.display='none'">&times;</span>
        </div>
        <div class="modal-body" style="padding: 30px;">
            <!-- EXPLANATION -->
            <div
                style="margin-bottom: 25px; padding: 15px; background: rgba(139, 92, 246, 0.1); border-left: 4px solid #8b5cf6; border-radius: 4px;">
                <p style="color: #e0e7ff; font-size: 0.95rem; margin: 0; line-height: 1.6;">
                    <strong>Evaluation Methodology:</strong> Metrics are calculated using <strong>5-Fold Time Series
                        Cross
                        Validation</strong> on the entire 220-day historical dataset.
                    Due to stable plant operation and limited variance, <strong>MAE (Mean Absolute Error)</strong>
                    and
                    <strong>RMSE</strong> are the primary indicators of performance.
                    R¬≤ is shown as a reference but should be interpreted cautiously in low-variance industrial
                    contexts.
                </p>
            </div>

            <!-- TARGET: Power Generation -->
            <h4 style="color: #cbd5e1; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                Target:
                Power Generation (MWh)</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <!-- PLOT 1: SCATTER -->
                <div style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: 8px; text-align: center;">
                    <h5 style="color: #94a3b8; margin-bottom: 10px;">Actual vs Predicted (Full History)</h5>
                    <img src="/output/forecasts/scatter_cv_Power_Generated_MWh.png" alt="Scatter Plot"
                        style="max-width: 100%; height: auto; border-radius: 4px;">
                </div>
                <!-- PLOT 2: ERROR DIST -->
                <div style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: 8px; text-align: center;">
                    <h5 style="color: #94a3b8; margin-bottom: 10px;">Error Distribution (Bias Check)</h5>
                    <img src="/output/forecasts/error_dist_Power_Generated_MWh.png" alt="Error Distribution"
                        style="max-width: 100%; height: auto; border-radius: 4px;">
                </div>
            </div>

            <!-- TARGET: Internal Demand (Optional Row) -->
            <h4
                style="color: #cbd5e1; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-top: 30px;">
                Target: Internal Demand (MWh)</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <!-- PLOT 1: SCATTER -->
                <div style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: 8px; text-align: center;">
                    <img src="/output/forecasts/scatter_cv_Total_Internal_Cons_MWh.png" alt="Scatter Plot"
                        style="max-width: 100%; height: auto; border-radius: 4px;">
                </div>
                <!-- PLOT 2: ERROR DIST -->
                <div style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: 8px; text-align: center;">
                    <img src="/output/forecasts/error_dist_Total_Internal_Cons_MWh.png" alt="Error Distribution"
                        style="max-width: 100%; height: auto; border-radius: 4px;">
                </div>
            </div>
        </div>
    </div>
</div>